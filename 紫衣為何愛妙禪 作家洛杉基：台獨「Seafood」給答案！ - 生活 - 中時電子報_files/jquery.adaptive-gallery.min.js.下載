"use strict";!function(t){t.fn.adaptiveGallery=function(e,i,a){var n=t.Deferred();return a&&a.push(n.promise()),this.each(function(){var a,o=t.extend({},{stageAspectRatio:1.5,defaultIndex:1,toShowCaptionOnSmallScreen:!0,isCaptionCompacted:!1,isCaptionCollapsable:!1,isCaptionLandAside:!1,toShowDateTime:!1,toShowClicks:!1,toShowReadMoreButton:!1,readMoreButtonText:"閱讀全文",infiniteLoopMode:!1,toRotate:!1,interval:6e3,toLazyLoadPhoto:!0,toAutoPlayVideo:!0,toPushState:!1,stateIndexKey:"adaptiveGallery",stateIndexField:{field:"captionTitle",className:".caption-title"}},i),s=o.stageAspectRatio,r=o.defaultIndex,l=o.toShowCaptionOnSmallScreen,d=o.isCaptionCompacted,c=o.isCaptionCollapsable,h=o.isCaptionLandAside,u=o.toShowDateTime,p=o.toShowClicks,g=o.toShowReadMoreButton,f=o.readMoreButtonText,m=o.infiniteLoopMode,v=o.toLazyLoadPhoto,w=o.toAutoPlayVideo,C=o.toRotate,b=o.interval,y=o.toPushState,k=o.stateIndexKey,T=o.stateIndexField,A=e.length,S="ontouchstart"in document&&(navigator.maxTouchPoints||"Win32"!==navigator.platform),x=/[\s\`\~\!\@\#\$\%\^\&\*\(\)\-\_\=\+\[\{\]\}\\\|\;\:\'\"\,\<\.\>\/\?]/g,P=function(e){return t("<div>"+e+"</div>").text()},X=[],Y=function(i){var u,p,g,f,Y,I=t(i).find(".adaptive-gallery:last"),U=I.find(".stage-container"),M=I.find(".item-group"),D=M.find(".item-entry"),E=D.find(".caption"),R=I.find(".navigation"),q=R.find(".position-indicator"),z=R.find(".btn"),V=R.find(".btn-prev"),L=R.find(".btn-next"),j=t(window),B=1e3*parseFloat(M.css("transition-duration")),H=r,O={isMouseDown:!1,startX:0,startY:0,currentX:0,currentY:0,endX:0,endY:0,deltaX:0,deltaY:0},F=function(t){var e,i,a,n=window.location.href,o=0;if(!(n.indexOf("?")>-1))return null;for(i=(e=n.split("?")[1].split("&")).length;o<i;o+=1)if((a=e[o]).split("=")[0]===t)return decodeURIComponent(a.split("=")[1])},N=function(){C&&(a=setInterval(function(){var t;(H+=1)>A&&(t=1,H=1),q.find("li").eq(H-1).trigger("click",[!1,t])},b),t(document).data(k+"Timer",a))},K=function(){clearInterval(a)};U.on({init:function(t){t.stopPropagation(),U.trigger("setSize"),setTimeout(function(){D.trigger("setPhotoRelativeAspectRatio")},100)},setSize:function(){g=I.width(),f=g/s,h&&g<768&&(f*=1.5),U.css({"min-height":"",height:Math.floor(f),width:Math.floor(g)}).removeClass("extra-large large medium-large medium small extra-small"),g>=1024?U.addClass("extra-large"):g<1024&&g>=768?U.addClass("large"):g<768&&g>=480?U.addClass("medium-large"):g<480&&g>=360?U.addClass("medium"):g<360&&g>=320?U.addClass("small"):U.addClass("extra-small")},mouseenter:function(){S||(z.trigger("show"),clearTimeout(Y))},mouseleave:function(){S||z.trigger("hide")}}),M.on({click:function(e,i){i&&(H=t(this).index()+1,m&&(H-1==0?H=A:H-=1),q.find("li").eq(H-1).trigger("click",[!0]))}},".item-entry"),M.on({scrollToPointer:function(){var t=100*(H+(m?1:0)-1-O.deltaX/g);M.css({transform:"translate3d("+-t+"%, 0, 0)",transition:"none"})},scrollToCurrent:function(t,e,i){var a;switch(e){case 1:a=m?100*(H+A):0;break;case-1:a=0;break;default:a=100*(H+(m?1:0)-1)}i?M.css("transition","none"):M.css("transition",""),M.css({transform:"translate3d("+-a+"%, 0, 0)"}),setTimeout(function(){e&&M.css({transform:"translate3d("+-100*(m?1===e?1:A:0)+"%, 0, 0)",transition:"none"})},B)}}),M.on({mousedown:function(t){t.preventDefault(),O.isMouseDown=!0,O.startX=t.clientX,O.startY=t.clientY},mousemove:function(e){if(!O.isMouseDown)return!1;O.currentX=e.clientX,O.currentY=e.clientY,O.deltaX=O.currentX-O.startX,O.deltaY=O.currentY-O.startY,t(this).trigger("moveContents")},mouseup:function(e){O.isMouseDown=!1,O.endX=e.clientX,O.endY=e.clientY,O.deltaX=O.endX-O.startX,O.deltaY=O.endY-O.startY,t(this).trigger("updateContents")},touchstart:function(t){var e=t.originalEvent.targetTouches[0];O.startX=e.clientX,O.startY=e.clientY},touchmove:function(e){var i=e.originalEvent.targetTouches[0];if(e.originalEvent.touches.length>1)return!1;O.currentX=i.clientX,O.currentY=i.clientY,O.deltaX=O.currentX-O.startX,O.deltaY=O.currentY-O.startY,Math.abs(O.deltaX)>Math.abs(O.deltaY)&&e.preventDefault(),t(this).trigger("moveContents")},touchend:function(e){var i=e.originalEvent.changedTouches[0];O.endX=i.clientX,O.endY=i.clientY,O.deltaX=O.endX-O.startX,O.deltaY=O.endY-O.startY,t(this).trigger("updateContents")},moveContents:function(){if(H+(m?1:0)-1==0&&O.deltaX>0||H===A+(m?1:0)&&O.deltaX<0||1===A)return!1;M.trigger("scrollToPointer")},updateContents:function(){var t=0;if(1===A)return!1;O.deltaX<-50?m?((H+=1)>A&&(t=1,H=1),q.find("li").eq(H-1).trigger("click",[!1,t])):H-1<A&&q.find("li").eq(H+1-1).trigger("click"):O.deltaX>50?m?((H-=1)<1&&(t=-1,H=A),q.find("li").eq(H-1).trigger("click",[!1,t])):H-1>0&&q.find("li").eq(H-1-1).trigger("click"):M.trigger("scrollToCurrent")},click:function(e){var i=t(e.target);Math.abs(O.deltaX)<10?i.parents().is(E)&&!d&&c&&!h&&i.trigger("toggleStatus"):e.preventDefault()},setPhotoRelativeAspectRatio:function(){var e=t(this).find(".cropper"),i=e.width(),a=e.height(),n=i/a;e.attr({"data-width":i,"data-height":a,"data-aspect-ratio":n}),imgSpecialized(e,n)},loadLazyPhoto:function(){var e=t(this),i=e.find(".photo");v&&"photo"===e.attr("data-media-type")&&!e.is(".ready")&&(i.attr("src",i.attr("data-large-photo-url")),i.one({load:function(){e.addClass("ready"),frontEndSpecialized(e,function(){e.trigger("setPhotoRelativeAspectRatio"),e.data("photoAlignCenter")&&e.photoAlignCenter()})}}))},pauseVideo:function(){var e,i,a=t(this).find("[data-vendor-name]");if(a.length)switch(e=a.attr("data-vendor-name"),i=a.attr("id"),e){case"youtube":a.get(0).contentWindow.postMessage(a.attr("data-command-pause"),"*");break;case"facebook":t.each(X,function(t,e){e.id===i&&e.instance.pause()})}},playVideo:function(){var e,i,a=t(this).find("[data-vendor-name]");if(a.length)switch(e=a.attr("data-vendor-name"),i=a.attr("id"),e){case"youtube":setTimeout(function(){a.get(0).contentWindow.postMessage(a.attr("data-command-play"),"*")},1e3);break;case"facebook":t.each(X,function(t,e){e.id===i&&setTimeout(function(){e.instance.play()},1e3)})}}},".item-entry"),M.on({dragstart:function(t){t.preventDefault()}},"img, a"),E.on({init:function(e){var i=t(this),a=i.parents(".container"),n=I.width(),o=JSON.parse(i.attr("data-to-show-caption"));if(e.stopPropagation(),!o||!l&&n<480)return i.hide(),!1;i.show(),h&&(n<768?(a.removeClass("caption-land-aside"),n<480?i.removeClass("land-aside"):i.addClass("land-aside")):(a.addClass("caption-land-aside"),i.addClass("land-aside"))),i.trigger("showHideInnerBlocks")},showHideInnerBlocks:function(){var e=t(this),i=e.find(".caption-container"),a=e.find("time"),n=e.find(".clicks"),o=e.find(".caption-text"),s=e.find(".btn-more"),r=[s,a,n,o],l=[o,n,a,s];for(h||(r=[o,a,s],l=[s,a,o]);i.outerHeight(!0)<=e.height()&&r.length;)r.shift().show();for(;i.outerHeight(!0)>e.height()&&l.length;)l.shift().hide()},toggleStatus:function(){t(this).toggleClass("expanded collapsed")}}),R.on({init:function(e,i){var a=t(this);e.stopPropagation(),1===A?a.hide():z.trigger("init",[i])}}),z.on({init:function(e,i){e.stopPropagation(),i||S||(t(this).trigger("show"),clearTimeout(Y),Y=setTimeout(function(){z.trigger("hide")},1e4))},show:function(){t(this).removeClass("hide").addClass("show")},hide:function(){t(this).removeClass("show").addClass("hide")},updateStatus:function(){if(m)return!1;H-1==0?V.removeClass("hover").addClass("disabled"):V.removeClass("disabled"),H===A?L.removeClass("hover").addClass("disabled"):L.removeClass("disabled")}}),z.on({"mouseenter touchstart":function(){var e=t(this).parent();if(e.is(".disabled"))return!1;e.addClass("hover")},touchmove:function(){t(this).parent().removeClass("hover")},mouseleave:function(){t(this).parent().removeClass("hover")},swapHoverImage:function(e,i){var a=t(this).find("img"),n=a.attr("src");i?a.attr("src",n.replace(".png","-hover.png")):a.attr("src",n.replace("-hover.png",".png"))},click:function(){var e=t(this),i=e.parent(),a=0;if(i.is(".disabled"))return!1;i.is(L)?(H+=1)>A&&(a=1,H=1):(H-=1)<1&&(a=-1,H=A),S&&setTimeout(function(){i.removeClass("hover")},600),q.find("li").eq(H-1).trigger("click",[!1,a]),e.trigger("updateStatus")}},"a"),q.on({click:function(e,i,a,n){var o=t(this);H=o.index()+1,M.trigger("scrollToCurrent",[a,n]),z.trigger("updateStatus"),o.trigger("updateStatus").trigger("pushState",[i]),t.each([H,H+1],function(t,e){e>=1&&e<=A&&(m&&(2===(e+=1)&&D.eq(0).trigger("loadLazyPhoto"),e===A+1&&D.eq(A+1).trigger("loadLazyPhoto")),D.eq(e-1).trigger("loadLazyPhoto"))}),D.filter('[data-media-type="video"]').trigger("pauseVideo"),w&&(m?D.eq(H-1+1).trigger("playVideo"):D.eq(H-1).trigger("playVideo"))},updateStatus:function(){t(this).addClass("current").siblings().removeClass("current")},pushState:function(i,a){var n,o,s,r;if(!y||a)return!1;if(n=window.History,o=P(e[H-1][T.field]),s=o.replace(x,""),r={title:document.title,url:t.query.SET(k,s)},history.pushState)history.pushState(r,r.title,r.url);else{if(!n.pushState)return!1;n.pushState(r,r.title,r.url)}}},"li"),U.on({"mouseenter touchstart":function(){K()},mouseleave:function(){N()}}),I.on({init:function(t,e){t.stopPropagation(),U.trigger("init"),E.trigger("init"),R.trigger("init",[e])}}).trigger("init"),j.on({resize:function(){u===j.width()&&p===j.height()||(u=j.width(),p=j.height(),I.trigger("init",[!0]))}}),function(){var i,a,n=F(k),s=function(){return 0===r?Math.ceil(Math.random()*A):parseInt(o.defaultIndex,10)};n?(i=n.replace(x,""),t.each(e,function(t){if((a=P(this[T.field]).replace(x,""))===i)return H=t+1,!1}),H||(H=s())):H=s(),q.find("li").eq(H-1).trigger("click",[!1,void 0,!0])}(),N(),n.resolve(k)};!function(i){var a=t(i),n=function(){var t="";t+='<div class="adaptive-gallery'+(S?" is-touch-device":"")+'" data-state-index-field="'+T.className+'" data-state-index-key="'+k+'"><div class="stage-container" style="min-height: 0;"><div class="stage-cropper"><ul class="item-group"></ul><div class="navigation"><ol class="position-indicator"></ol><div class="btn btn-prev '+(S?"show":"hide")+'"><a href="javascript:;">&lt;</a></div><div class="btn btn-next '+(S?"show":"hide")+'"><a href="javascript:;">&gt;</a></div></div></div></div></div>',a.append(t)},o=function(){var i=a.find(".item-group"),n=a.find(".position-indicator"),o=[],l=[],w=t.extend([],e);m&&(w.unshift(e[A-1]),w.push(e[0])),t.each(w,function(e){!function(e){var i,a,n=[{name:"youtube",urlMatchPattern:[/www.youtube.com\/watch/i,/youtu.be/i,/www.youtube.com\/embed/i],getId:function(t){var e,i,n,o;switch(a){case 0:for(n=(e=t.split("?")[1].split("&")).length,i=0;i<n;i+=1)if("v"===(o=e[i]).split("=")[0])return o.split("=")[1];break;case 1:return t.split(".be/")[1].split("?")[0];case 2:for(n=(e=t.split(" ")).length,i=0;i<n;i+=1)if("src"===(o=e[i]).split("=")[0])return o.split("=")[1].split("/embed/")[1].replace('"',"")}},getThumbImage:function(t,e){var i=this.getId(t);return e=-1===e?Math.ceil(3*Math.random()):e,"https://img.youtube.com/vi/"+i+"/"+e+".jpg"},getEmbedCode:function(t,e,i){var a=this.getId(t);return e=e||"100%",i=i||"100%","<iframe width='"+e+"' height='"+i+"' src='https://www.youtube.com/embed/"+a+'?wmode=transparent&enablejsapi=1&rel=0\' frameborder=\'0\' allowfullscreen data-vendor-name=\'youtube\' data-command-pause=\'{"event": "command", "func": "pauseVideo"}\' data-command-play=\'{"event": "command", "func": "playVideo"}\'></iframe>'}},{name:"facebook",urlMatchPattern:[/www.facebook.com/i],getId:function(t){switch(a){case 0:return t.split("/videos/")[1].replace("/","")}},getThumbImage:function(t){return"https://graph.facebook.com/"+this.getId(t)+"/picture"},getEmbedCode:function(t,e,i){var a=this.getId(t);return e=e||"",i=i||"",'<div id="'+a+'" class="fb-video" data-width="'+e+'" style="height: '+i+'" data-allowfullscreen="true" data-href="'+t+'" data-vendor-name="facebook"></div>'}}];if(t.each(n,function(){var n=this;t.each(n.urlMatchPattern,function(t,o){if(o.test(e.largePhotoUrl))return i=n,a=t,!1})}),i)switch(e.mediaType="video",i.name){case"youtube":e.photoUrl=e.photoUrl||i.getThumbImage(e.largePhotoUrl,-1),e.largePhotoUrl=i.getEmbedCode(e.largePhotoUrl);break;case"facebook":e.photoUrl=e.photoUrl||i.getThumbImage(e.largePhotoUrl),e.largePhotoUrl=i.getEmbedCode(e.largePhotoUrl)}else e.mediaType||(e.mediaType="photo")}(this),o.push('<li class="item-entry'+(!0===this.toShowVideoIcon?" video":"")+'" data-media-type="'+this.mediaType+'">'),o.push('<div class="container'+(h?" caption-land-aside":"")+'">'),o.push('<div class="cropper">'),"photo"===this.mediaType?(o.push('<a href="'+this.linkUrl+'" target="'+this.linkTarget+'" title="'+P(this.captionTitle)+'" data-link-url="'+this.linkUrl+'" data-link-target="'+this.linkTarget+'">'),v&&r!==(v?e:e+1)?o.push('<img class="photo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" alt="'+P(this.captionTitle)+'" data-photo-url="'+this.photoUrl+'" data-large-photo-url="'+this.largePhotoUrl+'" data-media-type="'+this.mediaType+'">'):o.push('<img class="photo" src="'+this.largePhotoUrl+'" alt="'+P(this.captionTitle)+'" data-photo-url="'+this.photoUrl+'" data-large-photo-url="'+this.largePhotoUrl+'" data-media-type="'+this.mediaType+'">'),this.toShowVideoIcon&&o.push('<span class="ico-video"></span>'),o.push("</a>")):(o.push('<div class="video-frame">'),o.push(this.largePhotoUrl),o.push("</div>")),o.push('<div class="caption'+(h?" land-aside":(c?" collapsable":"")+(d?" compacted":" expanded"))+'" data-to-show-caption="'+(!1===this.toShowCaption?"false":"true")+'">'),o.push('<div class="caption-container">'),o.push('<div class="bgn"></div>'),o.push('<h3 class="caption-title" data-caption-title="'+P(this.captionTitle)+'">'),this.linkUrl&&o.push('<a href="'+this.linkUrl+'" target="'+this.linkTarget+'">'),o.push(this.captionTitle),this.linkUrl&&o.push("</a>"),o.push("</h3>"),o.push('<div class="meta-info">'),this.captionDateTime&&u&&o.push('<time datetime="'+this.captionDateTime+'">'+this.captionDateTime+"</time>"),this.clicks&&p&&h&&(o.push('<div class="clicks">'),o.push("點閱：<span>"+this.clicks+"</span>"),o.push("</div>")),o.push("</div>"),this.captionText&&o.push('<p class="caption-text" data-caption-text="'+P(this.captionText)+'">'+this.captionText+"</p>"),d||!c||h||o.push('<span class="pointer"></span>'),g&&o.push('<div class="btn-more"><a href="'+this.linkUrl+'" target="'+this.linkTarget+'">'+f+"</a></div>"),o.push("</div>"),o.push("</div>"),this.clicks&&p&&!h&&(o.push('<div class="clicks">'),o.push('<a title="點閱數" href="'+this.linkUrl+'" target="'+this.linkTarget+'">'+this.clicks+"</a>"),o.push("</div>")),o.push("</div>"),o.push("</div>"),o.push("</li>"),(!m||0!==e&&e!==A+1)&&l.push('<li><a href="javascript:;">'+(e+1)+"</a></li>")}),i.append(o.join("")),n.append(l.join("")),s(a)},s=function(t){frontEndSpecialized(t,function(){Y(a)})};!function(){var e=t.Deferred();window.frontEndSpecialized?e.resolve():t.ajax({url:"//static.chinatimes.com/scripts/front-end-specialized.min.js",dataType:"script",crossDomain:!0,success:function(){e.resolve()}}),t.when(e.promise()).done(function(){window.fbAsyncInit=function(){FB.init({xfbml:!0,version:"v2.5"}),FB.Event.subscribe("xfbml.ready",function(t){"video"===t.type&&X.push({id:t.id,instance:t.instance})})},n(),o()})}()}(this)})}}(jQuery);